# Безопасность проекта WhatsApp Scheduler

Этот документ содержит информацию о политике безопасности проекта, обнаруженных проблемах и способах их устранения.

## Известные уязвимости и их решения

### Уязвимость DoS в библиотеке ws (CVE-2023-45857)

**Проблема**: Библиотеки ws (версии 8.0.0 - 8.17.0) подвержены уязвимости типа "отказ в обслуживании" (DoS) при обработке запросов с большим количеством HTTP-заголовков.

**Ссылка на уязвимость**: [GHSA-3h5v-q93c-6h6q](https://github.com/advisories/GHSA-3h5v-q93c-6h6q)

**Затронутые компоненты**:
- ws (прямая зависимость и вложенная в whatsapp-web.js)
- puppeteer-core (зависит от уязвимой версии ws)
- puppeteer (зависит от уязвимой версии puppeteer-core)
- whatsapp-web.js (зависит от уязвимой версии puppeteer)

**Решение**:

В проекте были приняты следующие меры:
1. Обновлена версия puppeteer до 22.0.0 или выше
2. Добавлены настройки переопределения зависимостей (overrides) для принудительного использования безопасной версии ws
3. Добавлен скрипт postinstall для установки правильной версии Chromium

### Улучшение безопасности Electron

**Проблема**: В предыдущих версиях приложения не были внедрены рекомендуемые настройки безопасности Electron, что могло привести к потенциальным уязвимостям.

**Решение**:

Следующие улучшения безопасности были внедрены в соответствии с [официальными рекомендациями Electron](https://www.electronjs.org/docs/latest/tutorial/security):

1. **Включены безопасные настройки BrowserWindow**:
   - `nodeIntegration: false` - отключена интеграция Node.js в рендерер
   - `contextIsolation: true` - включена изоляция контекста
   - `sandbox: true` - включен режим песочницы
   - `webSecurity: true` - включены стандартные веб-механизмы безопасности
   - `allowRunningInsecureContent: false` - запрещено выполнение небезопасного контента

2. **Добавлена Content-Security-Policy**:
   - Настроены ограничения на источники контента
   - Разрешены только необходимые домены для работы приложения

3. **Настроены разрешения приложения**:
   - Добавлен контроль за запрашиваемыми разрешениями через `setPermissionRequestHandler`
   - Разрешаются только необходимые для работы приложения разрешения (media, notifications)

4. **Улучшено взаимодействие между процессами**:
   - Добавлена валидация входных данных для всех IPC-обработчиков
   - Улучшена обработка ошибок при коммуникации между процессами

5. **Режим разработки/production**:
   - Отладочные инструменты (DevTools) доступны только в режиме разработки
   - Отключены потенциально небезопасные функции в production-версии

## Проблема отображения QR-кода

**Проблема**: В предыдущих версиях приложения QR-код для авторизации WhatsApp Web мог отображаться некорректно или вообще не отображаться в интерфейсе, что приводило к необходимости использования консольного QR-кода.

**Решение**:

1. **Улучшены параметры генерации QR-кода**:
   - Добавлены настройки для повышения надежности считывания: высокий уровень коррекции ошибок, оптимальный размер, улучшенный масштаб
   - Исправлена асинхронная обработка генерации QR-кода

2. **Улучшен пользовательский интерфейс**:
   - Добавлены индикаторы загрузки QR-кода
   - Добавлена визуальная индикация ошибок при генерации/загрузке QR-кода
   - Добавлены обработчики событий загрузки изображения для корректного отображения состояния

3. **Добавлен механизм повторных попыток**:
   - При ошибке генерации QR-кода автоматически запускается повторная попытка
   - Добавлена обработка события для повторной генерации QR-кода

4. **Улучшена очистка ресурсов**:
   - Добавлен механизм корректного удаления обработчиков событий для предотвращения утечек памяти
   - Оптимизирована работа с глобальными ресурсами

## Установка с учетом проблем безопасности

При установке проекта выполните следующие шаги для обеспечения безопасности:

1. **Клонируйте репозиторий**:
   ```
   git clone https://github.com/SLAVAWEBru/whatsapp-scheduler.git
   cd whatsapp-scheduler
   ```

2. **Удалите предыдущие установки (если есть)**:
   - Удалите папку node_modules (если она существует)
   - Удалите файл package-lock.json (если он существует)

3. **Установите зависимости с проверкой безопасности**:
   ```
   npm install
   ```

4. **Запустите в режиме разработки** (для проверки):
   ```
   npm run dev
   ```

5. **Для production-версии**:
   ```
   npm start
   ```

6. **Для сборки установщика**:
   ```
   npm run build
   ```

## Отчеты о проблемах безопасности

Если вы обнаружили уязвимость в WhatsApp Scheduler, пожалуйста, сообщите об этом, создав issue в репозитории с тегом "security".

## Автоматическое обновление зависимостей

Данный проект использует GitHub Dependabot для автоматического отслеживания и обновления зависимостей. Это помогает своевременно устранять уязвимости безопасности в используемых библиотеках.
